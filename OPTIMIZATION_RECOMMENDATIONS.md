# üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ Telegram-–±–æ—Ç–∞

## üìä –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

–ü–æ—Å–ª–µ –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞ –≤—ã—è–≤–ª–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (—Ç—Ä–µ–±—É—é—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è)

1. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö - –≥–ª–∞–≤–Ω–æ–µ —É–∑–∫–æ–µ –º–µ—Å—Ç–æ**
   - –ò–∑–±—ã—Ç–æ—á–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `selectinload()` –∏ `joinedload()` –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å
   - –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å—Ç—Ä–æ–∫ —á–µ—Ä–µ–∑ `with_for_update()` 
   - –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - N+1 –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–Ω–æ–ø–∫–∞–º**
   - –ö–∞–∂–¥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ = 3-5 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
   - –ù–µ—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è InlineKeyboard –º–µ–Ω—é
   - –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø—Ä–æ–≤–µ—Ä–æ–∫ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ –∫–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ

3. **–ü–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç LLM**
   - –ò–∑–±—ã—Ç–æ—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ regex fallback
   - 3-4 –ø–æ–ø—ã—Ç–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –Ω–∞ –∫–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç
   - –ù–µ—Ç –∫–µ—à–∞ –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤

## üíä –†–µ—à–µ–Ω–∏—è –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å –ë–î

#### –î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã:
```python
# –í db.py –¥–æ–±–∞–≤–∏—Ç—å –≤ –∫–ª–∞—Å—Å—ã:

class ChatBotInstance(Base):
    __table_args__ = (
        UniqueConstraint('chat_id', 'bot_instance_id', name='_chat_bot_uc'),
        Index('ix_chat_bot_active', 'chat_id', 'active'),  # NEW
        Index('ix_chat_bot_instance', 'bot_instance_id', 'active'),  # NEW
    )

class ChatContext(Base):
    __table_args__ = (
        Index('ix_context_chat_order', 'chat_bot_instance_id', 'message_order'),  # NEW
    )
```

#### –£–±—Ä–∞—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ selectinload:
```python
# –ë–´–õ–û:
user = db.query(User).options(
    selectinload(User.persona_configs).selectinload(DBPersonaConfig.bot_instance)
).filter(User.id == user_id).one()

# –°–¢–ê–õ–û:
user = db.query(User).filter(User.id == user_id).one()
# –ó–∞–≥—Ä—É–∂–∞—Ç—å —Å–≤—è–∑–∏ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω—ã
if need_personas:
    personas = db.query(DBPersonaConfig).filter(
        DBPersonaConfig.owner_id == user.id
    ).all()
```

#### –î–æ–±–∞–≤–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Redis:
```python
import redis
import json
from functools import wraps

redis_client = redis.Redis(
    host='localhost', 
    port=6379, 
    decode_responses=True,
    socket_connect_timeout=1,
    socket_timeout=1
)

def cache_result(ttl=60):
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            cache_key = f"{func.__name__}:{str(args)}:{str(kwargs)}"
            try:
                cached = redis_client.get(cache_key)
                if cached:
                    return json.loads(cached)
            except:
                pass
            
            result = await func(*args, **kwargs)
            
            try:
                redis_client.setex(
                    cache_key, 
                    ttl, 
                    json.dumps(result, default=str)
                )
            except:
                pass
                
            return result
        return wrapper
    return decorator

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
@cache_result(ttl=300)  # 5 –º–∏–Ω—É—Ç
async def get_user_personas(user_id: int):
    # –∑–∞–ø—Ä–æ—Å –∫ –ë–î
    pass
```

### 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–Ω–æ–ø–æ–∫

#### –ö–µ—à–∏—Ä–æ–≤–∞—Ç—å InlineKeyboard –º–µ–Ω—é:
```python
# handlers.py
MENU_CACHE = {}

def get_menu_keyboard(user_id: int) -> InlineKeyboardMarkup:
    cache_key = f"menu_{user_id}"
    
    if cache_key in MENU_CACHE:
        return MENU_CACHE[cache_key]
    
    keyboard = [
        [
            InlineKeyboardButton("–ø—Ä–æ—Ñ–∏–ª—å", callback_data="show_profile"),
            InlineKeyboardButton("–º–æ–∏ –ª–∏—á–Ω–æ—Å—Ç–∏", callback_data="show_mypersonas")
        ],
        [InlineKeyboardButton("–ø–æ–º–æ—â—å", callback_data="show_help")]
    ]
    
    markup = InlineKeyboardMarkup(keyboard)
    MENU_CACHE[cache_key] = markup
    
    # –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
    asyncio.create_task(clear_cache_after(cache_key, 300))
    
    return markup
```

#### –£–ø—Ä–æ—Å—Ç–∏—Ç—å callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏:
```python
# –ë–´–õ–û: –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î
async def handle_callback_query(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    
    with get_db() as db:
        user = get_user(db, user_id)  # –ó–∞–ø—Ä–æ—Å 1
        personas = get_personas(db, user.id)  # –ó–∞–ø—Ä–æ—Å 2
        bot_instance = get_bot_instance(db, ...)  # –ó–∞–ø—Ä–æ—Å 3
        # –∏ —Ç.–¥.

# –°–¢–ê–õ–û: –æ–¥–∏–Ω –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
async def handle_callback_query(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    
    # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ context
    user_data = context.user_data.get('cached_user')
    if not user_data or time.time() - user_data.get('ts', 0) > 300:
        with get_db() as db:
            user_data = load_user_data_optimized(db, user_id)
            context.user_data['cached_user'] = {
                'data': user_data,
                'ts': time.time()
            }
```

### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞ LLM –æ—Ç–≤–µ—Ç–æ–≤

#### –£–ø—Ä–æ—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ JSON:
```python
def parse_llm_response(text: str) -> List[str]:
    """–£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –±–µ–∑ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö fallback"""
    # –£–±—Ä–∞—Ç—å markdown –æ–±–µ—Ä—Ç–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
    if text.startswith("```") and text.endswith("```"):
        text = text[3:-3].strip()
        if text.startswith("json\n"):
            text = text[5:]
    
    try:
        # –ü—Ä–æ–±—É–µ–º –∫–∞–∫ JSON
        parsed = json.loads(text)
        if isinstance(parsed, dict) and "response" in parsed:
            resp = parsed["response"]
            if isinstance(resp, list):
                return [str(x) for x in resp if x]
            return [str(resp)] if resp else []
        if isinstance(parsed, list):
            return [str(x) for x in parsed if x]
    except:
        # –ü—Ä–æ—Å—Ç–æ–π fallback - —Ä–∞–∑–±–∏—Ç—å –ø–æ —Å—Ç—Ä–æ–∫–∞–º
        return [line.strip() for line in text.split('\n') if line.strip()]
    
    return [text]  # –ö—Ä–∞–π–Ω–∏–π —Å–ª—É—á–∞–π
```

### 4. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

#### –ó–∞–º–µ–Ω–∏—Ç—å threading.RLock –Ω–∞ asyncio.Lock:
```python
# –ë–´–õ–û:
bot_swap_lock = threading.RLock()

# –°–¢–ê–õ–û:
bot_swap_lock = asyncio.Lock()

async def process_update():
    async with bot_swap_lock:
        # –æ–±—Ä–∞–±–æ—Ç–∫–∞
        pass
```

#### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å connection pool –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API:
```python
import httpx

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç —Å –ø—É–ª–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
http_client = httpx.AsyncClient(
    limits=httpx.Limits(
        max_keepalive_connections=10,
        max_connections=20,
        keepalive_expiry=30
    ),
    timeout=httpx.Timeout(30.0)
)

async def send_to_openrouter(...):
    # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç
    response = await http_client.post(...)
```

### 5. –û—á–∏—Å—Ç–∫–∞ –∫–æ–¥–∞

#### –£–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–æ–¥:
- –£–±—Ä–∞—Ç—å DEPRECATED –ø–æ–ª—è –∏–∑ –ë–î (daily_message_count, last_message_reset)
- –£–¥–∞–ª–∏—Ç—å –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–æ–∫
- –£–±—Ä–∞—Ç—å –ø—É—Å—Ç—ã–µ `except: pass` –±–ª–æ–∫–∏ –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ

#### –£–º–µ–Ω—å—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
```python
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
logger.debug(...)  # –î–µ—Ç–∞–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞ - –≤—ã–∫–ª—é—á–µ–Ω–æ –≤ –ø—Ä–æ–¥–µ
logger.info(...)   # –í–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
logger.warning(...) # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
logger.error(...)  # –¢–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏
```

### 6. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î –≤ config.py:
```python
# –£–≤–µ–ª–∏—á–∏—Ç—å –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
DB_POOL_SIZE = int(os.getenv("DB_POOL_SIZE", "20"))  # –±—ã–ª–æ 5
DB_MAX_OVERFLOW = int(os.getenv("DB_MAX_OVERFLOW", "30"))  # –±—ã–ª–æ 10

# –î–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–µ—à–∞
CACHE_TTL_USER = 300  # 5 –º–∏–Ω—É—Ç
CACHE_TTL_PERSONA = 600  # 10 –º–∏–Ω—É—Ç
CACHE_TTL_MENU = 1800  # 30 –º–∏–Ω—É—Ç
```

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ PTB:
```python
# main.py
builder.concurrent_updates(True)  # –£–∂–µ –µ—Å—Ç—å
builder.connection_pool_size(100)  # –£–≤–µ–ª–∏—á–∏—Ç—å —Å 50
builder.pool_timeout(30.0)  # –£–≤–µ–ª–∏—á–∏—Ç—å —Å 20
```

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —ç—Ç–∏—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:

1. **–°–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–∫–ª–∏–∫–∞ –∫–Ω–æ–ø–æ–∫**: —Å 2-3 —Å–µ–∫ –¥–æ 100-300 –º—Å
2. **–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î**: —Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 70-80%
3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏**: —Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 30-40%
4. **–û–±—â–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤ 3-5 —Ä–∞–∑

## üîÑ –ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

1. **–§–∞–∑–∞ 1 (1-2 –¥–Ω—è)**: –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –∏ —É–±—Ä–∞—Ç—å –ª–∏—à–Ω–∏–µ selectinload
2. **–§–∞–∑–∞ 2 (2-3 –¥–Ω—è)**: –í–Ω–µ–¥—Ä–∏—Ç—å Redis –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
3. **–§–∞–∑–∞ 3 (1 –¥–µ–Ω—å)**: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ LLM
4. **–§–∞–∑–∞ 4 (1 –¥–µ–Ω—å)**: –û—á–∏—Å—Ç–∏—Ç—å –∫–æ–¥ –æ—Ç –º—É—Å–æ—Ä–∞
5. **–§–∞–∑–∞ 5 (—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)**: –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ë–î —Ç—Ä–µ–±—É—é—Ç —Å–æ–∑–¥–∞–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π —á–µ—Ä–µ–∑ Alembic
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–Ω–∞—á–∞–ª–∞ –Ω–∞ dev –æ–∫—Ä—É–∂–µ–Ω–∏–∏
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞
- –î–µ–ª–∞—Ç—å –±—ç–∫–∞–ø—ã –ë–î –ø–µ—Ä–µ–¥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏

---

*–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –ø–æ—Å–ª–µ –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Ä–∞—Å—Å—Ç–∞–≤–ª–µ–Ω—ã –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É –≤–ª–∏—è–Ω–∏—è –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.*
